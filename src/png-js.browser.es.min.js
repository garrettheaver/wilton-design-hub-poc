import{inflate as inflate$1}from"pako/lib/inflate";var range=function(t,e,a){for(var r=[],s=t<e,i=a?s?e+1:e-1:e,n=t;s?n<i:n>i;s?n++:n--)r.push(n);return r},classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),toConsumableArray=function(t){if(Array.isArray(t)){for(var e=0,a=Array(t.length);e<t.length;e++)a[e]=t[e];return a}return Array.from(t)},IndexedPNG=function(){function t(e){classCallCheck(this,t),this.data=e,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.text={},this.process()}return createClass(t,[{key:"process",value:function(){for(var t=this,e=void 0;;){var a,r=this.readUInt32();switch(function(){var a=[];for(e=0;e<4;e++)a.push(String.fromCharCode(t.data[t.pos++]));return a}().join("")){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bitsPerColor=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"PLTE":this.palette=this.read(r);break;case"IDAT":for(e=0,a=r;e<a;e++)this.imgData.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(r);var s,i,n=255-this.transparency.indexed.length;if(n>0)for(e=0,s=0<=(i=n);s?e<i:e>i;s?e++:e--)this.transparency.indexed.push(0);break;case 0:this.transparency.grayscale=this.read(r)[0];break;case 2:this.transparency.rgb=this.read(r)}break;case"tEXt":var h=this.read(r),o=h.indexOf(0),c=String.fromCharCode.apply(String,toConsumableArray(Array.from(h.slice(0,o)||[])));this.text[c]=String.fromCharCode.apply(String,toConsumableArray(Array.from(h.slice(o+1)||[])));break;case"IEND":this.colorsPerPixel=function(){switch(t.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}(),this.hasAlphaChannel=[4,6].includes(this.colorType);var l=this.colorsPerPixel+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bitsPerColor*l,this.colorSpace=function(){switch(t.colorsPerPixel){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}(),void(this.imgData=new Uint8Array(this.imgData));default:this.pos+=r}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt IndexedPNG file")}}},{key:"read",value:function(t){var e=this;return range(0,t,!1).map(function(t){return e.data[e.pos++]})}},{key:"readUInt32",value:function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]}},{key:"readUInt16",value:function(){return this.data[this.pos++]<<8|this.data[this.pos++]}},{key:"decodePixels",value:async function(){var t=void 0;try{t=inflate$1(this.imgData)}catch(t){throw t}for(var e=this.pixelBitlength/8,a=e*this.width,r=new Uint8Array(a*this.height),s=t.length,i=0,n=0,h=0;n<s;){var o,c,l,d,u,f,p,y,v,g;switch(t[n++]){case 0:for(l=0,f=a;l<f;l++)r[h++]=t[n++];break;case 1:for(l=0,p=a;l<p;l++)o=t[n++],d=l<e?0:r[h-e],r[h++]=(o+d)%256;break;case 2:for(l=0,y=a;l<y;l++)o=t[n++],c=(l-l%e)/e,u=i&&r[(i-1)*a+c*e+l%e],r[h++]=(u+o)%256;break;case 3:for(l=0,v=a;l<v;l++)o=t[n++],c=(l-l%e)/e,d=l<e?0:r[h-e],u=i&&r[(i-1)*a+c*e+l%e],r[h++]=(o+Math.floor((d+u)/2))%256;break;case 4:for(l=0,g=a;l<g;l++){var b,k;o=t[n++],c=(l-l%e)/e,d=l<e?0:r[h-e],0===i?u=k=0:(u=r[(i-1)*a+c*e+l%e],k=c&&r[(i-1)*a+(c-1)*e+l%e]);var m=d+u-k,w=Math.abs(m-d),P=Math.abs(m-u),x=Math.abs(m-k);b=w<=P&&w<=x?d:P<=x?u:k,r[h++]=(o+b)%256}break;default:throw new Error("Invalid filter algorithm: "+t[n-1])}i++}return r}},{key:"decodePalette",value:function(){for(var t=this.palette,e=this.transparency.indexed||[],a=new Uint8Array(t.length/3*4),r=0,s=(t.length,0),i=0,n=t.length;i<n;i+=3){var h;a[r++]=t[i],a[r++]=t[i+1],a[r++]=t[i+2],a[r++]=null!=(h=e[s++])?h:255}return a}},{key:"toPNGData",value:async function(t){for(var e=t.palette||this.decodedPalette,a=this.decodedPixels.length,r=new Uint8ClampedArray(4*a),s=this.decodedPixels,i=0,n=0;n<a;n++){var h=4*s[n];r[i++]=e[h],r[i++]=e[h+1],r[i++]=e[h+2],r[i++]=e[h+3]}return{pixels:r,width:this.width}}},{key:"toImageData",value:async function(t){var e=await this.toPNGData(t);return new ImageData(e.pixels,e.width)}},{key:"decode",value:async function(){this.decodedPalette=this.decodePalette(),this.decodedPixels=await this.decodePixels()}}]),t}();export default IndexedPNG;
